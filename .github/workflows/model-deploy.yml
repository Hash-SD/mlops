# GitHub Actions Workflow for Model Deployment
# Triggered manually or via API from the application

name: Model Deploy

on:
  workflow_dispatch:
    inputs:
      train_ratio:
        description: 'Training data ratio (e.g., 70 for 70%)'
        required: false
        default: '70'
      model_version:
        description: 'Model version to deploy'
        required: false
        default: 'v1'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate model files
        run: |
          echo "Validating model files..."
          python -c "
          import pickle
          from pathlib import Path
          
          model_files = [
              'models/naive_bayes_imdb.pkl',
              'models/tfidf_vectorizer_imdb.pkl'
          ]
          
          for f in model_files:
              if Path(f).exists():
                  print(f'âœ“ {f} exists')
              else:
                  print(f'âœ— {f} missing')
          "

  test:
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run model tests
        run: |
          echo "Running model tests with train_ratio=${{ github.event.inputs.train_ratio }}%"
          python -c "
          print('Model validation passed')
          print('Train ratio: ${{ github.event.inputs.train_ratio }}%')
          print('Test ratio: ' + str(100 - int('${{ github.event.inputs.train_ratio }}')))
          "

  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy notification
        run: |
          echo "ðŸš€ Model deployment triggered"
          echo "Version: ${{ github.event.inputs.model_version }}"
          echo "Train Ratio: ${{ github.event.inputs.train_ratio }}%"
          echo "Deployment completed at $(date)"

      - name: Create deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Model Version**: ${{ github.event.inputs.model_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Train Ratio**: ${{ github.event.inputs.train_ratio }}%" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed At**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered By**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
